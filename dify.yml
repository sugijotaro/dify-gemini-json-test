app:
  description: ãƒ­ãƒ¼ã‚«ãƒ«ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€å¤‰æ•°ã‚’çµŒç”±ã—ã¦Gemini File APIã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—ã—ã¾ã™ã€‚
  icon: ğŸ“¤
  icon_background: "#D6EAF8"
  mode: workflow
  name: Gemini File Upload - Step 1 with Var Check
  use_icon_as_answer_icon: false
dependencies: []
kind: app
version: 0.2.0
workflow:
  conversation_variables: []
  environment_variables:
    - description: "Google Gemini API Key" # èª¬æ˜ã‚’ä¿®æ­£
      id: env_gemini_api_key
      name: GEMINI_API_KEY
      selector:
        - env
        - GEMINI_API_KEY
      value: ""
      value_type: secret
  features:
    file_upload:
      allowed_file_extensions:
        - .MP4
        - .MOV
        - .AVI
        - .WEBM
        - .MPEG
      allowed_file_types:
        - video
      allowed_file_upload_methods:
        - local_file
      enabled: true
      fileUploadConfig: # ã”æç¤ºã®å€¤ã‚’å‚è€ƒã«ã—ã¤ã¤ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆç”¨ã«èª¿æ•´
        audio_file_size_limit: 50
        batch_count_limit: 1 # 1ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤
        file_size_limit: 2000 # Difyå´ã®åˆ¶é™
        image_file_size_limit: 10
        video_file_size_limit: 2000 # Difyå´ã®åˆ¶é™
        workflow_file_upload_limit: 1
      image:
        enabled: false
      number_limits: 1
    opening_statement: Gemini File APIã§å‡¦ç†ã™ã‚‹å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
      # Start -> Code Node
      - data:
          isInLoop: false
          sourceType: start
          targetType: code
        id: edge_start_to_code # IDã‚’åˆ†ã‹ã‚Šã‚„ã™ã
        source: node_start
        sourceHandle: source
        target: node_code_prepare_vars # Codeãƒãƒ¼ãƒ‰ã®ID
        targetHandle: target
        type: custom
      # Code Node -> HTTP Start Upload
      - data:
          isInLoop: false
          sourceType: code
          targetType: http-request
        id: edge_code_to_http_start_upload # IDã‚’åˆ†ã‹ã‚Šã‚„ã™ã
        source: node_code_prepare_vars
        sourceHandle: source
        target: node_http_start_upload
        targetHandle: target
        type: custom
      # HTTP Start Upload -> End
      - data:
          isInLoop: false
          sourceType: http-request
          targetType: end
        id: edge_http_start_upload_to_end
        source: node_http_start_upload
        sourceHandle: source
        target: node_end
        targetHandle: target
        type: custom

    nodes:
      - data:
          desc: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã™ã€‚
          selected: false
          title: é–‹å§‹
          type: start
          variables:
            - allowed_file_extensions: []
              allowed_file_types:
                - video
              allowed_file_upload_methods:
                - local_file
              # - remote_url # ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã‚’æƒ³å®š
              label: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«
              max_length: 48
              options: []
              required: true
              type: file
              variable: uploaded_video_file
        height: 134 # ã”æç¤ºã®å€¤ã‚’å‚è€ƒã«
        id: node_start
        position: { x: 50, y: 200 }
        type: custom
        width: 244 # ã”æç¤ºã®å€¤ã‚’å‚è€ƒã«
      - data:
          code: | # Pythonã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£
            def main(input_mime_type: str, input_num_bytes: int, input_display_name: str) -> dict:
                # input_mime_type, input_num_bytes, input_display_name ã¯
                # Difyã®Codeãƒãƒ¼ãƒ‰ã®ã€Œå…¥åŠ›å¤‰æ•°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®šç¾©ã—ãŸå¤‰æ•°åã«å¯¾å¿œã—ã¾ã™ã€‚
                # DifyãŒã“ã‚Œã‚‰ã®å€¤ã‚’å¼•æ•°ã¨ã—ã¦mainé–¢æ•°ã«æ¸¡ã—ã¦ãã‚Œã¾ã™ã€‚

                # ã“ã“ã§å¿…è¦ã«å¿œã˜ã¦å€¤ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã‚ŠåŠ å·¥ã—ãŸã‚Šã§ãã‚‹
                # ä¾‹: print(f"MIME Type: {input_mime_type}")
                # ä¾‹: print(f"Num Bytes: {input_num_bytes}")
                # ä¾‹: print(f"Display Name: {input_display_name}")

                processed_mime_type = input_mime_type
                processed_num_bytes = str(input_num_bytes) # HTTPãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ã«æ–‡å­—åˆ—ã«å¤‰æ›
                processed_display_name = input_display_name

                # ASCIIã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã®ä¾‹ (ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«åãŒåŸå› ã®å ´åˆ)
                # import re
                # processed_display_name = re.sub(r'[^\x00-\x7F]+', '_', input_display_name)

                # è¿”ã‚Šå€¤ã®è¾æ›¸ã®ã‚­ãƒ¼ãŒã€Codeãƒãƒ¼ãƒ‰ã®ã€Œå‡ºåŠ›å¤‰æ•°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®šç¾©ã—ãŸå¤‰æ•°åã«å¯¾å¿œã—ã¾ã™ã€‚
                return {
                    "MIME_TYPE_OUT": processed_mime_type,
                    "NUM_BYTES_OUT": processed_num_bytes,
                    "DISPLAY_NAME_OUT": processed_display_name
                }
          code_language: python3
          desc: 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆMIMEã‚¿ã‚¤ãƒ—, ã‚µã‚¤ã‚º, åå‰ï¼‰ã‚’æº–å‚™ãƒ»ç¢ºèªã—ã¾ã™ã€‚'
          outputs: # å‡ºåŠ›å¤‰æ•°ã®å®šç¾©
            DISPLAY_NAME_OUT:
              type: string
            MIME_TYPE_OUT:
              type: string
            NUM_BYTES_OUT:
              type: string
          selected: false
          title: 'æº–å‚™: ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±'
          type: code
          variables: # å…¥åŠ›å¤‰æ•°ã®ãƒãƒƒãƒ”ãƒ³ã‚°
          - value_selector:
            - node_start
            - uploaded_video_file
            - mime_type
            variable: input_mime_type # mainé–¢æ•°ã®å¼•æ•°åã¨ä¸€è‡´ã•ã›ã‚‹
          - value_selector:
            - node_start
            - uploaded_video_file
            - size
            variable: input_num_bytes # mainé–¢æ•°ã®å¼•æ•°åã¨ä¸€è‡´ã•ã›ã‚‹
          - value_selector:
            - node_start
            - uploaded_video_file
            - name
            variable: input_display_name # mainé–¢æ•°ã®å¼•æ•°åã¨ä¸€è‡´ã•ã›ã‚‹
        height: 220
        id: node_code_prepare_vars
        position: { x: 350, y: 200 }
        type: custom
        width: 280
      - data:
          authorization:
            type: no-auth
          body:
            data: # JSONæ–‡å­—åˆ—ã¨ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
              '{
              "file": {
              "displayName": "{{#node_code_prepare_vars.DISPLAY_NAME_OUT#}}"
              }
              }'
            type: json
          desc: "Gemini File API: Resumable uploadã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—ã—ã¾ã™ã€‚"
          headers: | # ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ã£ãŸè¤‡æ•°è¡Œãƒ˜ãƒƒãƒ€ãƒ¼ã«æˆ»ã™
            X-Goog-Upload-Protocol: resumable
            X-Goog-Upload-Command: start
            X-Goog-Upload-Header-Content-Type: {{#node_code_prepare_vars.MIME_TYPE_OUT#}}
            X-Goog-Upload-Header-Content-Length: {{#node_code_prepare_vars.NUM_BYTES_OUT#}}
            Content-Type: application/json; charset=utf-8
          method: post
          params: "uploadType=resumable&key={{#env.GEMINI_API_KEY#}}" # keyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
          retry_config:
            max_retries: "1"
            retry_enabled: false
            retry_interval: 5000
          selected: false
          # ssl_verify ã¨ timeout ã¯Difyã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹ã‹ã€å¿…è¦ãªã‚‰æ˜ç¤º
          title: "1. File API: Start Upload Session"
          type: http-request
          url: https://generativelanguage.googleapis.com/upload/v1beta/files
        height: 260 # ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¢—ãˆãŸã®ã§å°‘ã—é«˜ã•ã‚’èª¿æ•´
        id: node_http_start_upload
        position: { x: 680, y: 200 } # Codeãƒãƒ¼ãƒ‰ã®å¾Œã‚ã«é…ç½®
        type: custom
        width: 300
      - data:
          desc: File APIé–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
          outputs:
            - value_selector:
                - node_http_start_upload
                - headers
              variable: response_headers
            - value_selector:
                - node_http_start_upload
                - body
              variable: response_body
            - value_selector:
                - node_http_start_upload
                - status_code
              variable: status_code
            # Codeãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚‚ç¢ºèªã§ãã‚‹ã‚ˆã†ã«è¿½åŠ  (ãƒ‡ãƒãƒƒã‚°ç”¨)
            - value_selector:
                - node_code_prepare_vars
                - MIME_TYPE_OUT
              variable: prepared_mime_type
            - value_selector:
                - node_code_prepare_vars
                - NUM_BYTES_OUT
              variable: prepared_num_bytes
            - value_selector:
                - node_code_prepare_vars
                - DISPLAY_NAME_OUT
              variable: prepared_display_name
          selected: false
          title: çµ‚äº† (Upload URLå–å¾—çµæœã¨æº–å‚™å¤‰æ•°)
          type: end
        height: 240 # å‡ºåŠ›é …ç›®ãŒå¢—ãˆãŸã®ã§èª¿æ•´
        id: node_end
        position: { x: 1030, y: 200 } # HTTPãƒãƒ¼ãƒ‰ã®å¾Œã‚ã«é…ç½®
        type: custom
        width: 320 # å°‘ã—åºƒã‚ã«

    viewport: { x: 0, y: 0, zoom: 0.8 } # å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«èª¿æ•´
