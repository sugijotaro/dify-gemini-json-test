app:
  description: ãƒ­ãƒ¼ã‚«ãƒ«å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€Gemini File APIã§ãƒ•ã‚¡ã‚¤ãƒ«URIã‚’å–å¾—å¾Œã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã‚’è¡Œã„ã¾ã™ã€‚
  icon: ğŸ“¤
  icon_background: "#D6EAF8"
  mode: workflow
  name: Gemini Full Video Upload and Process
  use_icon_as_answer_icon: false
dependencies: # JSON Parseãƒ„ãƒ¼ãƒ«ç”¨ã«ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ 
  - current_identifier: null
    type: marketplace
    value:
      marketplace_plugin_unique_identifier: langgenius/json_process:0.0.2@7afb534cc85b28a8e9c7f9410d1cfc31fb7bd3950023355a37059dbe809ac776
kind: app
version: 0.2.0
workflow:
  conversation_variables: []
  environment_variables:
    - description: "Google Gemini API Key" # ã”æç¤ºã®IDã§ã¯ãªãã€èª¬æ˜çš„ãªåå‰ã«
      id: env_gemini_api_key # DifyãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹IDã«ä»»ã›ã‚‹ã‹ã€å›ºå®šã®UUIDãªã©
      name: GEMINI_API_KEY
      selector:
        - env
        - GEMINI_API_KEY
      value: ""
      value_type: secret
  features:
    file_upload:
      allowed_file_extensions:
        - .MP4
        - .MOV
        - .AVI
        - .WEBM
        - .MPEG
      allowed_file_types:
        - video
      allowed_file_upload_methods:
        - local_file
      enabled: true
      fileUploadConfig: # èª¿æ•´
        audio_file_size_limit: 50
        batch_count_limit: 1
        file_size_limit: 2000
        image_file_size_limit: 10
        video_file_size_limit: 2000
        workflow_file_upload_limit: 1
      image:
        enabled: false
      number_limits: 1
    opening_statement: Gemini File APIã§å‡¦ç†ã™ã‚‹å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
      - data:
          isInLoop: false
          sourceType: start
          targetType: code
        id: edge_start_to_code
        source: node_start
        sourceHandle: source
        target: node_code_prepare_vars
        targetHandle: target
        type: custom
      - data:
          isInLoop: false
          sourceType: code
          targetType: http-request
        id: edge_code_to_http_start_upload
        source: node_code_prepare_vars
        sourceHandle: source
        target: node_http_start_upload
        targetHandle: target
        type: custom
      - data:
          isInLoop: false
          sourceType: http-request
          targetType: if-else
        id: edge_http_start_to_if_else # IDä¿®æ­£
        source: node_http_start_upload
        sourceHandle: source
        target: node_if_else_check_status # If/Elseãƒãƒ¼ãƒ‰ã®ID
        targetHandle: target
        type: custom
      - data: # If/Else False -> End (Initial API Call Failed)
          isInLoop: false
          sourceType: if-else
          targetType: end
        id: edge_if_else_false_to_end_initial_fail # IDä¿®æ­£
        source: node_if_else_check_status
        sourceHandle: "false" # If/Elseã®falseåˆ†å²
        target: node_end_initial_api_failed # å¤±æ•—æ™‚ã®çµ‚äº†ãƒãƒ¼ãƒ‰ID
        targetHandle: target
        type: custom
      - data: # If/Else True -> HTTP Upload Data Actual
          isInLoop: false
          sourceType: if-else
          targetType: http-request
        id: edge_if_else_true_to_http_upload_actual # IDä¿®æ­£
        source: node_if_else_check_status
        sourceHandle: "true" # If/Elseã®trueåˆ†å²
        target: node_http_upload_data_actual # å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒãƒ¼ãƒ‰ID
        targetHandle: target
        type: custom
      # New Edges for the rest of the flow
      - data: # HTTP Upload Data Actual -> Extract File URI
          isInLoop: false
          sourceType: http-request
          targetType: tool
        id: edge_http_upload_actual_to_extract_uri
        source: node_http_upload_data_actual
        sourceHandle: source
        target: node_extract_file_uri
        targetHandle: target
        type: custom
      - data: # Extract File URI -> HTTP Generate Content
          isInLoop: false
          sourceType: tool
          targetType: http-request
        id: edge_extract_uri_to_generate_content
        source: node_extract_file_uri
        sourceHandle: source
        target: node_http_generate_content
        targetHandle: target
        type: custom
      - data: # HTTP Generate Content -> Extract Text
          isInLoop: false
          sourceType: http-request
          targetType: tool
        id: edge_generate_content_to_extract_text
        source: node_http_generate_content
        sourceHandle: source
        target: node_extract_text
        targetHandle: target
        type: custom
      - data: # Extract Text -> End Success
          isInLoop: false
          sourceType: tool
          targetType: end
        id: edge_extract_text_to_end_success
        source: node_extract_text
        sourceHandle: source
        target: node_end_success
        targetHandle: target
        type: custom

    nodes:
      - data:
          desc: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã™ã€‚
          selected: false
          title: é–‹å§‹
          type: start
          variables:
            - allowed_file_extensions: []
              allowed_file_types:
                - video
              allowed_file_upload_methods:
                - local_file
              label: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«
              max_length: 48
              options: []
              required: true
              type: file
              variable: uploaded_video_file
        height: 134
        id: node_start
        position:
          x: 50
          y: 300 # Yè»¸ã‚’èª¿æ•´ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿
        type: custom
        width: 244
      - data:
          code:
            "def main(input_mime_type: str, input_num_bytes: int, input_display_name:\
            \ str) -> dict:\n    processed_mime_type = input_mime_type\n    processed_num_bytes\
            \ = str(input_num_bytes)\n    processed_display_name = input_display_name\n\
            \    return {\n        \"MIME_TYPE_OUT\": processed_mime_type,\n       \
            \ \"NUM_BYTES_OUT\": processed_num_bytes,\n        \"DISPLAY_NAME_OUT\"\
            : processed_display_name\n    }\n"
          code_language: python3
          desc: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ï¼ˆMIMEã‚¿ã‚¤ãƒ—, ã‚µã‚¤ã‚º, åå‰ï¼‰ã‚’æº–å‚™ãƒ»ç¢ºèªã—ã¾ã™ã€‚
          outputs:
            DISPLAY_NAME_OUT: { type: string }
            MIME_TYPE_OUT: { type: string }
            NUM_BYTES_OUT: { type: string }
          selected: false
          title: "æº–å‚™: ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±"
          type: code
          variables:
            - {
                value_selector: [node_start, uploaded_video_file, mime_type],
                variable: input_mime_type,
              }
            - {
                value_selector: [node_start, uploaded_video_file, size],
                variable: input_num_bytes,
              }
            - {
                value_selector: [node_start, uploaded_video_file, name],
                variable: input_display_name,
              }
        height: 220
        id: node_code_prepare_vars
        position:
          x: 330
          y: 300
        type: custom
        width: 280
      - data:
          authorization: { type: no-auth }
          body:
            data:
              - type: text
                value: '{ "file": { "displayName": "{{#node_code_prepare_vars.DISPLAY_NAME_OUT#}}" } }'
            type: json
          desc: "Gemini File API: Resumable uploadã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—ã—ã¾ã™ã€‚"
          headers: |
            X-Goog-Upload-Protocol: resumable
            X-Goog-Upload-Command: start
            X-Goog-Upload-Header-Content-Type: {{#node_code_prepare_vars.MIME_TYPE_OUT#}}
            X-Goog-Upload-Header-Content-Length: {{#node_code_prepare_vars.NUM_BYTES_OUT#}}
            Content-Type: application/json; charset=utf-8
          method: post
          params: "uploadType=resumable&key={{#env.GEMINI_API_KEY#}}"
          retry_config:
            { max_retries: "1", retry_enabled: false, retry_interval: 5000 }
          selected: false
          title: "1. File API: Start Upload Session"
          type: http-request
          url: https://generativelanguage.googleapis.com/upload/v1beta/files
        height: 260
        id: node_http_start_upload
        position:
          x: 640
          y: 300
        type: custom
        width: 300
      - data: # If/Else Node
          cases:
            - case_id: "true" # Trueåˆ†å²ã®ID
              conditions: # æ¡ä»¶ãƒªã‚¹ãƒˆ
                - comparison_operator: "=" # æ¯”è¼ƒæ¼”ç®—å­
                  id: condition_status_200 # æ¡ä»¶ã®ä¸€æ„ãªID
                  value: "200" # æ¯”è¼ƒã™ã‚‹å€¤ (æ–‡å­—åˆ—ã¨ã—ã¦)
                  varType: number # æ¯”è¼ƒã™ã‚‹å¤‰æ•°ã®å‹ (Difyã§ã¯status_codeã¯æ•°å€¤ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹æƒ³å®š)
                  variable_selector: # æ¯”è¼ƒã™ã‚‹å¤‰æ•°
                    - node_http_start_upload # å‚ç…§å…ƒãƒãƒ¼ãƒ‰ID
                    - status_code # å‚ç…§å…ƒãƒãƒ¼ãƒ‰ã®å‡ºåŠ›å¤‰æ•°
              logical_operator: and # è¤‡æ•°æ¡ä»¶ã®å ´åˆã®è«–ç†æ¼”ç®—å­ (ä»Šå›ã¯1ã¤ãªã®ã§andã§ã‚‚orã§ã‚‚å¯)
          desc: "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ200ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚"
          selected: false
          title: "IF/ELSE: Status OK?"
          type: if-else
        height: 126
        id: node_if_else_check_status # IDã‚’ã”æç¤ºã® '1747208180415' ã‹ã‚‰å¤‰æ›´
        position:
          x: 970
          y: 300
        type: custom
        width: 244
      - data: # End Node for Initial API Call Failure
          desc: "æœ€åˆã®File APIå‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚"
          outputs: # å¤±æ•—æƒ…å ±ã‚’è¡¨ç¤º
            - value_selector: [node_http_start_upload, status_code]
              variable: error_status_code
            - value_selector: [node_http_start_upload, body]
              variable: error_body
          selected: false
          title: "çµ‚äº†: Upload URLå–å¾—å¤±æ•—"
          type: end
        height: 150 # å°‘ã—èª¿æ•´
        id: node_end_initial_api_failed # IDã‚’ã”æç¤ºã® 'node_end' ã‹ã‚‰å¤‰æ›´
        position:
          x: 1280 # IF/ELSEã®Falseåˆ†å²ã®å…ˆ
          y: 150 # Yè»¸ã‚’ãšã‚‰ã—ã¦é…ç½®
        type: custom
        width: 300
      - data: # HTTP Request Node for Actual Data Upload (If/Else True branch)
          authorization: { type: no-auth }
          body:
            data: "{{#node_start.uploaded_video_file.data#}}" # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿æœ¬ä½“
            type: binary # ãƒã‚¤ãƒŠãƒªã¨ã—ã¦é€ä¿¡
          desc: "å®Ÿéš›ã®å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚"
          headers: |
            Content-Length: {{#node_code_prepare_vars.NUM_BYTES_OUT#}}
            X-Goog-Upload-Offset: 0
            X-Goog-Upload-Command: upload, finalize
            # Content-Type ã¯APIå´ãŒåˆ¤æ–­ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€šå¸¸ä¸è¦ã ãŒã€å¿…è¦ãªã‚‰è¿½åŠ 
            # Content-Type: {{#node_code_prepare_vars.MIME_TYPE_OUT#}}
          method: put
          params: "" # URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸è¦
          retry_config:
            { max_retries: "1", retry_enabled: true, retry_interval: 10000 }
          selected: false
          title: "2. File API: Upload Actual Data"
          type: http-request
          url: "{{#node_http_start_upload.headers.X-Goog-Upload-URL#}}" # å‰ã®ãƒãƒ¼ãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—
        height: 220
        id: node_http_upload_data_actual # æ–°ã—ã„ID
        position:
          x: 1280 # IF/ELSEã®Trueåˆ†å²ã®å…ˆ
          y: 300
        type: custom
        width: 300
      - data: # JSON Parse Node to Extract File URI
          desc: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®URIã‚’æŠ½å‡ºã—ã¾ã™ã€‚"
          provider_id: langgenius/json_process/json_process # ä¾å­˜é–¢ä¿‚ã§æŒ‡å®šã—ãŸãƒ„ãƒ¼ãƒ«
          provider_name: langgenius/json_process/json_process
          provider_type: builtin
          selected: false
          title: "3. Extract File URI"
          tool_label: JSON Parse
          tool_name: parse
          tool_parameters:
            content:
              type: mixed
              value: "{{#node_http_upload_data_actual.body#}}" # ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£
            json_filter:
              type: mixed
              value: file.uri # file.uri ã‚’æŠ½å‡º
          type: tool
        height: 120
        id: node_extract_file_uri
        position:
          x: 1610 # Xä½ç½®ã‚’èª¿æ•´
          y: 300
        type: custom
        width: 280
      - data: # HTTP Request Node for Generate Content
          authorization: { type: no-auth }
          body:
            data: |
              {
                "contents": [{
                  "parts":[
                    {"file_data":{"mime_type": "{{#node_code_prepare_vars.MIME_TYPE_OUT#}}", "file_uri": "{{#node_extract_file_uri.text#}}"}},
                    {"text": "Summarize this video. Then create a quiz with an answer key based on the information in this video."}
                  ]
                }]
              }
            type: json
          desc: "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå‹•ç”»ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã—ã¾ã™ã€‚"
          headers: "Content-Type: application/json; charset=utf-8"
          method: post
          params: "key={{#env.GEMINI_API_KEY#}}"
          retry_config:
            { max_retries: "1", retry_enabled: true, retry_interval: 5000 }
          selected: false
          title: "4. Gemini: Generate Content"
          type: http-request
          url: "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent" # ãƒ¢ãƒ‡ãƒ«åã‚’å›ºå®š (ã¾ãŸã¯å¤‰æ•°åŒ–)
        height: 200
        id: node_http_generate_content
        position:
          x: 1940 # Xä½ç½®ã‚’èª¿æ•´
          y: 300
        type: custom
        width: 300
      - data: # JSON Parse Node to Extract Text from Generate Content Response
          desc: "ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¾ã™ã€‚"
          provider_id: langgenius/json_process/json_process
          provider_name: langgenius/json_process/json_process
          provider_type: builtin
          selected: false
          title: "5. Extract Generated Text"
          tool_label: JSON Parse
          tool_name: parse
          tool_parameters:
            content:
              type: mixed
              value: "{{#node_http_generate_content.body#}}"
            json_filter:
              type: mixed
              value: candidates[0].content.parts[0].text
          type: tool
        height: 120
        id: node_extract_text
        position:
          x: 2270 # Xä½ç½®ã‚’èª¿æ•´
          y: 300
        type: custom
        width: 280
      - data: # End Node for Successful Completion
          desc: "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
          outputs:
            - value_selector: [node_extract_file_uri, text]
              variable: uploaded_file_uri
            - value_selector: [node_extract_text, text]
              variable: generated_content_text
          selected: false
          title: "çµ‚äº†: æ­£å¸¸å®Œäº†"
          type: end
        height: 150
        id: node_end_success
        position:
          x: 2580 # Xä½ç½®ã‚’èª¿æ•´
          y: 300
        type: custom
        width: 300
    viewport:
      x: 0
      y: 0
      zoom: 1
